#!/usr/bin/env bash
# bin/compile build_path cache_path
#
# See https://blog.heroku.com/hacking-buildpacks#compile for good documentation
#
# build - gives you a handle for the root directory of the app
# cache - gives you a location to persist build artifacts between deployments
#
build="$1" # something like /tmp/build_<uuid>
cache="$2" # /app/tmp/cache

set -e # Raise errors if anything goes wrong

# Create a symbolic link to clamd folder:
ln -s /var/lib/clamav /app/.apt/var/lib/clamav

# Create the config file for the daemon:
touch "${build}/config/antivirus/clamd.conf"
echo "LocalSocket /app/config/antivirus/clamd.sock" > "${build}/config/antivirus/clamd.conf"

# Create the socket file for the daemon:
touch "${build}/config/antivirus/clamd.sock"

# Check for updates in the antivirus database
# Use the cache directory so that if the database hasn't changed, we can simply use the artifact from the previous deploy
mkdir -p "${cache}/clamav-data"
freshclam --config-file="${build}/config/antivirus/freshclam.conf" --datadir="${cache}/clamav-data/" --log=/dev/stdout

# Replace the current virus database with the new one:
rm -rf "${build}/.clamav-data"
cp -rp "${cache}/clamav-data" "${build}/.clamav-data"
